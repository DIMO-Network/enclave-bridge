FROM golang:1.24 as enclave-app-build

ENV CGO_ENABLED=0

WORKDIR /build
COPY . ./

RUN go mod tidy
RUN make build-enclave

FROM amazonlinux:2 AS release

WORKDIR /

COPY --from=dimozone/aws-nitro-enclaves-sdk-c:latest /usr/lib64/libnsm.so /usr/lib64/libnsm.so
COPY --from=enclave-app-build --chown=1001:1001 /build/bin/enclave-app /

ENV LD_LIBRARY_PATH="$LD_LIBRARY_PATH:/usr/lib64/"

USER 1001:1001

EXPOSE 5000

ENTRYPOINT ["./enclave-app", "5000"]